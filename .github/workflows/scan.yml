name: TruffleHog PR Secret Scan
on:
  pull_request:
    branches:
      - main  

jobs:
  scan-secrets:
    name: Scan for Secrets with TruffleHog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        id: trufflehog
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Check Results and Block PR
        run: |
          if [ "${{ steps.trufflehog.outcome }}" == "failure" ]; then
            echo "ðŸš¨ SECRETS DETECTED! This PR cannot be merged."
            echo "Check the TruffleHog step above for details."
            exit 1
          else
            echo "âœ… No secrets detected. PR can proceed."
          fi

      - name: Comment on PR if secrets found
        if: steps.trufflehog.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸš¨ Secrets Detected!
            
            This PR contains potential secrets and cannot be merged until they are removed.
            
            Please check the **TruffleHog OSS** step in the workflow run above for detailed information about the detected secrets.
            
            ### Next Steps:
            1. Review the detected secrets in the workflow logs
            2. Remove the secrets from your code
            3. Use environment variables or secure secret management instead
            4. Push your changes to update this PR
            
            The PR will be automatically re-scanned when you push new commits.`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
